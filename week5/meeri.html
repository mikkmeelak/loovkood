<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
	<title>LOOVKOOD</title>
	<style>
		/* here you can change the background */
		body { background-color:gray; }
		canvas { position: fixed; top: 0; right: 0; bottom: 0; left: 0; }
		img { display: none; }
		p { margin: 0; }

		.caption {
			position: fixed;
			top: 1vw;
			left: 1vw;

			font-family: sans-serif;
			font-size: 1.5vh;
			line-height: 1.5;
            color: white;

			z-index: 1000;
		}
	</style>
</head>

<body>
	<div class="caption">
		<p class="author">Meeri</p>
		<p class="desc">MÃ¤rg asfalt. Sebrad. Vihm. Vinguvad trolliliinid.</p>
	</div>
	<canvas id="canvas" resize keepalive="true" hidpi="off"></canvas>
	<img id="image" src="http://assets.paperjs.org/images/marilyn.jpg" crossorigin="anonymous">
</body>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.9.25/paper-full.min.js"></script>
<script type="text/javascript" src='http://js.leapmotion.com/leap-0.6.4.js'></script>
<script type="text/javascript">
	paper.install(window);

	window.onload = function() {
		paper.setup('canvas');

		view.viewSize = [ window.innerWidth, window.innerHeight ];
		window.onresize = function(event) { view.viewSize = [ window.innerWidth, window.innerHeight ]; }
		var tool = new Tool();


		// YOUR CODE STARTS HERE

		// measure screen size and save it
		var WIDTH = view.size.width;
		var HEIGHT = view.size.height;

		var AXIS_X = 0;
		var AXIS_Y = 0;

		// create a new box just for feedback that everything works
		// var BACKGROUND = new Path.Rectangle(0, 0, WIDTH, HEIGHT);
		// BACKGROUND.fillColor = new Color({
		// 	hue: 360,
		// 	saturation: 1,
		// 	brightness: 1
		// });

		// create a new box just for feedback that everything works
		var BOX = new Path.Rectangle(WIDTH / 2 - 170, HEIGHT / 2 - 50, 360, 360);


		BOX.strokeColor = new Color(4);
		BOX.strokeWidth = 66;

		// this function runs every frame
		view.onFrame = function(event) {
			BOX.rotate(78);	// spin the box

			// BOX.fillColor.hue = AXIS_X * 360;
			// BACKGROUND.fillColor.hue = AXIS_Y * 360;

			// BOX.strokeWidth = AXIS_Y * 48;
			BOX.dashArray = [ AXIS_X * 10, AXIS_Y * 10];

			for (var i = 0; i < BOX.segments.length; i++) {
				if (i % 2 == 0) {
					BOX.segments[i].point.x = AXIS_Y * WIDTH - WIDTH / 2 ;
				}
				else {
					BOX.segments[i].point.y = AXIS_X * WIDTH;
				}

			}

			// takes everything and centers it
			project.activeLayer.position = view.center;
		};

		view.onMouseMove = function(event) {
			AXIS_X = event.point.x / WIDTH;
			AXIS_Y = event.point.y / HEIGHT;
		};

		// sellega saab leap motioni toe
		Leap.loop( { background: true }, leapAnimate).connect();
		function leapAnimate(frame) {
			if (frame.hands.length > 0 && frame.hands[0].palmNormal) {
				AXIS_X = (frame.hands[0].palmNormal[0] + 1) / 2;
				AXIS_Y = (frame.hands[0].palmNormal[2] + 1) / 2;

				// console.log(AXIS_X, AXIS_Y);
			}
		}
	};

    // create web audio api context
var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// create Oscillator and gain node
var oscillator = audioCtx.createOscillator();
var gainNode = audioCtx.createGain();

// connect oscillator to gain node to speakers

oscillator.connect(gainNode);
gainNode.connect(audioCtx.destination);

// create initial theremin frequency and volumn values

var WIDTH = window.innerWidth;
var HEIGHT = window.innerHeight;

var maxFreq = 6000;
var maxVol = 0.02;

var initialFreq = 3000;
var initialVol = 0.001;

// set options for the oscillator

oscillator.type = 'square';
oscillator.frequency.value = initialFreq; // value in hertz
oscillator.detune.value = 100; // value in cents
oscillator.start(0);

oscillator.onended = function() {
  console.log('Your tone has now stopped playing!');
}

gainNode.gain.value = initialVol;

// Mouse pointer coordinates

var CurX;
var CurY;

// Get new mouse pointer coordinates when mouse is moved
// then set new gain and pitch values

document.onmousemove = updatePage;

function updatePage(e) {
    KeyFlag = false;

    CurX = (window.Event) ? e.pageX : event.clientX + (document.documentElement.scrollLeft ? document.documentElement.scrollLeft : document.body.scrollLeft);
    CurY = (window.Event) ? e.pageY : event.clientY + (document.documentElement.scrollTop ? document.documentElement.scrollTop : document.body.scrollTop);

    oscillator.frequency.value = (CurX/WIDTH) * maxFreq;
    gainNode.gain.value = (CurY/HEIGHT) * maxVol;

    canvasDraw();
}

// mute button

var mute = document.querySelector('.mute');

mute.onclick = function() {
  if(mute.getAttribute('data-muted') === 'false') {
    gainNode.disconnect(audioCtx.destination);
    mute.setAttribute('data-muted', 'true');
    mute.innerHTML = "Unmute";
  } else {
    gainNode.connect(audioCtx.destination);
    mute.setAttribute('data-muted', 'false');
    mute.innerHTML = "Mute";
  };
}



// canvas visualization

function random(number1,number2) {
  var randomNo = number1 + (Math.floor(Math.random() * (number2 - number1)) + 1);
  return randomNo;
}

var canvas = document.querySelector('.canvas');
canvas.width = WIDTH;
canvas.height = HEIGHT;

var canvasCtx = canvas.getContext('2d');

function canvasDraw() {
  if(KeyFlag == true) {
    rX = KeyX;
    rY = KeyY;
  } else {
    rX = CurX;
    rY = CurY;
  }
  rC = Math.floor((gainNode.gain.value/maxVol)*30);

  canvasCtx.globalAlpha = 0.2;

  for(i=1;i<=15;i=i+2) {
    canvasCtx.beginPath();
    canvasCtx.fillStyle = 'rgb(' + 100+(i*10) + ',' + Math.floor((gainNode.gain.value/maxVol)*255) + ',' + Math.floor((oscillator.frequency.value/maxFreq)*255) + ')';
    canvasCtx.arc(rX+random(0,50),rY+random(0,50),rC/2+i,(Math.PI/180)*0,(Math.PI/180)*360,false);
    canvasCtx.fill();
    canvasCtx.closePath();
  }
}

// clear screen

var clear = document.querySelector('.clear');

clear.onclick = function() {
  canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
}

// keyboard controls

var body = document.querySelector('body');

var KeyX = 1;
var KeyY = 0.01;
var KeyFlag = false;

body.onkeydown = function(e) {
  KeyFlag = true;

  // 37 is arrow left, 39 is arrow right,
  // 38 is arrow up, 40 is arrow down

  if(e.keyCode == 37) {
    KeyX -= 20;
  };

  if(e.keyCode == 39) {
    KeyX += 20;
  };

  if(e.keyCode == 38) {
    KeyY -= 20;
  };

  if(e.keyCode == 40) {
    KeyY += 20;
  };

  // set max and min constraints for KeyX and KeyY

  if(KeyX < 1) {
    KeyX = 1;
  };

  if(KeyX > WIDTH) {
    KeyX = WIDTH;
  };

  if(KeyY < 0.01) {
    KeyY = 0.01;
  };

  if(KeyY > HEIGHT) {
    KeyY = HEIGHT;
  };

  oscillator.frequency.value = (KeyX/WIDTH) * maxFreq;
  gainNode.gain.value = (KeyY/HEIGHT) * maxVol;

  canvasDraw();
}
</script>
</html>
